(function(t){function e(e){for(var s,n,o=e[0],l=e[1],c=e[2],d=0,h=[];d<o.length;d++)n=o[d],Object.prototype.hasOwnProperty.call(i,n)&&i[n]&&h.push(i[n][0]),i[n]=0;for(s in l)Object.prototype.hasOwnProperty.call(l,s)&&(t[s]=l[s]);u&&u(e);while(h.length)h.shift()();return r.push.apply(r,c||[]),a()}function a(){for(var t,e=0;e<r.length;e++){for(var a=r[e],s=!0,o=1;o<a.length;o++){var l=a[o];0!==i[l]&&(s=!1)}s&&(r.splice(e--,1),t=n(n.s=a[0]))}return t}var s={},i={app:0},r=[];function n(e){if(s[e])return s[e].exports;var a=s[e]={i:e,l:!1,exports:{}};return t[e].call(a.exports,a,a.exports,n),a.l=!0,a.exports}n.m=t,n.c=s,n.d=function(t,e,a){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:a})},n.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var a=Object.create(null);if(n.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)n.d(a,s,function(e){return t[e]}.bind(null,s));return a},n.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="/vuemusic/";var o=window["webpackJsonp"]=window["webpackJsonp"]||[],l=o.push.bind(o);o.push=e,o=o.slice();for(var c=0;c<o.length;c++)e(o[c]);var u=l;r.push([0,"chunk-vendors"]),a()})({0:function(t,e,a){t.exports=a("56d7")},"034f":function(t,e,a){"use strict";var s=a("64a9"),i=a.n(s);i.a},"21a0":function(t,e,a){},3611:function(t,e,a){"use strict";var s=a("21a0"),i=a.n(s);i.a},"3c4e":function(t,e,a){"use strict";var s=a("9cfa"),i=a.n(s);i.a},"56d7":function(t,e,a){"use strict";a.r(e);var s=a("2b0e"),i=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{attrs:{id:"app"}},[a("router-view")],1)},r=[],n=(a("034f"),a("2877")),o={},l=Object(n["a"])(o,i,r,!1,null,null,null),c=l.exports,u=a("8c4f"),d=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"home"},[t.loadingFs?a("md-progress-bar",{attrs:{"md-mode":"indeterminate"}}):t._e(),a("md-content",[a("playlist-view",{staticClass:"playlist-view",attrs:{playlist:t.likedTracks},on:{play:t.playMedia}})],1),a("media-player-view",{ref:"mediaPlayer",staticClass:"media-player",attrs:{"current-playlist":t.likedTracks}})],1)},h=[];class f{constructor(t,e,a){this.accessToken=t,this.expires=e,this.type=a}static fromJson(t){if(!t)return!1;try{let e=JSON.parse(t);return new f(e.accessToken,e.expires,e.type)}catch(e){return console.warn("Token parse error",e),!1}}}class p{static getServer(){return this.isLocal()?"http://localhost:3000":"https://ruurd.dev:3000"}static isLocal(){return location.href.includes("localhost")||location.href.includes("127.0.0.1")||location.href.includes("192.168.0")}static secondsToHms(t){if(isNaN(t)||void 0===t)return"0:00";t=Math.round(t);let e=Math.floor(t/3600),a=Math.floor(t%3600/60),s=t%60;return e=e.toString(),a=a.toString(),s=s.toString(),"0"!==e&&(a=a.padStart(2,"0"),s=s.padStart(2,"0")),s=s.padStart(2,"0"),"0"===e?`${a}:${s}`:`${e}:${a}:${s}`}static shuffleArray(t){for(let e=t.length-1;e>0;e--){const a=Math.floor(Math.random()*(e+1));[t[e],t[a]]=[t[a],t[e]]}return t}}class y{constructor(){this.isReady=!1,this.requestSize=536870912,this.events={},this.getFileSystem().then(async t=>{this.fileSystem=t,await this.requestMoreQuota(this.requestSize),this.isReady=!0,console.log("File storage loaded!"),this.fire("ready")})}async awaitReady(){return new Promise(t=>{this.isReady&&t(),this.on("ready",()=>{t()})})}get root(){return this.fileSystem.root}async exists(t,e=this.root){let a=await this.getFileByName(t,e);return console.log("Exists?",a),void 0!==a}async getFileByName(t,e=this.root){let a=await this.getDirectoryFiles(e);return a.find(e=>e.name===t)}async getDirectoryFiles(t=this.root){return new Promise((e,a)=>{let s=t.createReader();s.readEntries(t=>e(t),t=>a(t))})}async getFileSystem(){return new Promise((t,e)=>{window.webkitRequestFileSystem(window.PERSISTENT,0,e=>t(e),t=>e(t))})}async requestMoreQuota(t){return new Promise((e,a)=>{navigator.webkitPersistentStorage.requestQuota(t,t=>e(t),t=>a(t))})}async getCurrentQuota(){return new Promise((t,e)=>{navigator.webkitTemporaryStorage.queryUsageAndQuota((e,a)=>t({usedBytes:e,grantedBytes:a}),t=>e(t))})}async createFileFromBlob(t,e,a=this.root){let s=await this.createFile(t,a);return await this.writeToFile(e,s),s}async createFile(t,e=this.root){return console.log("file 1"),new Promise((a,s)=>{e.getFile(t,{create:!0,exclusive:!1},t=>a(t),t=>s(t))})}async writeToFile(t,e){return new Promise((a,s)=>{e.createWriter(e=>{e.onwriteend=t=>a(t),e.onerror=t=>s(t),e.write(t)})})}on(t,e){this.events[t]||(this.events[t]=[]),this.events[t].push(e)}off(t,e){this.events[t]&&this.events[t].splice(this.events.indexOf(e),1)}fire(t){if(this.events[t])for(let e of this.events[t])e()}}var m=new y;class g{constructor(t,e,a,s,i,r){this.id=t,this.title=e,this.artists=a,this.albumArt=s,this.duration=i/1e3,this.durationHms=p.secondsToHms(this.duration),this.addedAt=r,this.offline=!1,this.caching=!1,this.getCachedOfflineStatus()}static empty(){return new g("0","","","",0,0)}static fromJson(t){if(t)try{let e=JSON.parse(t);return new g(e.id,e.title,e.artists,e.albumArt,1e3*e.duration,e.addedAt)}catch(e){console.error("Can't parse ",e,"JSON:",t)}}static fromRawTrack(t){let e=t.track;return new g(e.id,e.name,e.artists.map(t=>t.name).join(", "),e.album.images[0].url,e.duration_ms,new Date(t.added_at))}get query(){return`${this.title} - ${this.artists}`}setOffline(){this.offline=!0;let t="offlineTrack"+this.id;localStorage[t]=this.offline}getCachedOfflineStatus(){let t="offlineTrack"+this.id;null!==localStorage.getItem(t)&&(this.offline="true"===localStorage[t])}async getOfflineStatus(){let t="offlineTrack"+this.id;await m.awaitReady(),this.offline=await m.exists(this.id),localStorage[t]=this.offline}}class k{constructor(t,e){this.name=t,this.tracks=e,this.activeTrack=e.length>0?e[0]:g.empty(),this.shuffledTracks=[],this.reshuffle()}exportJson(){return JSON.stringify({name:this.name,tracks:this.tracks})}static importJson(t){if(!t)return!1;try{let e=JSON.parse(t),a=e.tracks.map(t=>new g(t.id,t.title,t.artists,t.albumArt,1e3*t.duration,t.addedAt));return m.awaitReady().then(()=>{a.forEach(t=>t.getOfflineStatus())}),new k(e.name,a)}catch(e){console.error("Cant parse playlist",e,"JSON",t)}}static fromRawTracks(t,e){let a=e.map(g.fromRawTrack);return m.awaitReady().then(()=>{a.forEach(t=>t.getOfflineStatus())}),new k(t,a)}reshuffle(){this.shuffledTracks=p.shuffleArray([...this.tracks])}static empty(){return new k("",[])}}class v{constructor(){this.token=!1}async getLikedTracks(){let t="https://api.spotify.com/v1/me/tracks?limit=50",e=await this.requestPaginatedResource(t);return k.fromRawTracks("Liked songs",e)}async requestPaginatedResource(t){let e=await this.getToken(),a=[];while(t){let s=await(await fetch(t,{method:"GET",headers:{Authorization:"Bearer "+e.accessToken}})).json();t=s.next,a=a.concat(s.items)}return a}static verifyToken(t){if(!t)return!1;let e=Math.floor(+new Date/1e3),a=t.expires-e;return a>60}async getToken(){if(v.verifyToken(this.token))return this.token;if(null!==localStorage.getItem("token")){let t=f.fromJson(localStorage.token);if(v.verifyToken(t))return console.log("using localStorage token"),t}console.log("requesting new token");let t=await this.getTokenFromApi();return localStorage.token=JSON.stringify(t),this.token=t,t}async getTokenFromApi(){return new Promise((t,e)=>{const a="cd272aa2194c46c7a460e9a202f66002";let s=p.isLocal()?"http://localhost:8080/vuemusic/#/":"https://ruurd.dev/vuemusic/#/",i="user-library-read",r=Math.round(1e7*Math.random()).toString(),n=`https://accounts.spotify.com/authorize?response_type=token&state=${r}&client_id=${a}${i?"&scope="+encodeURIComponent(i):""}&redirect_uri=${encodeURIComponent(s)}`,o=window.open(n);console.log(o);let l=setInterval(()=>{let a=o.location.hash;if(a&&(o.close(),clearInterval(l),a.includes("error")&&(console.log("ERROR:",a),e(a)),a.includes("access_token"))){console.log("TOKEN:",a);let s=a.split("access_token=")[1].split("&")[0],i=a.split("token_type=")[1].split("&")[0],n=a.split("expires_in=")[1].split("&")[0],o=a.split("state=")[1].split("&")[0],l=Math.floor(+new Date/1e3)+ +n,c=new f(s,l,i);if(o!==r)return void e({message:`State doens't match: ${o}, ${r}`,token:c});t(c)}console.log(o.location.hash)},100)})}}var w=new v,T=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"playlist-view"},[a("h2",{staticClass:"playlist-name"},[t._v("\n        "+t._s(t.playlist.name)+"\n    ")]),a("recycle-scroller",{staticClass:"song-list",attrs:{items:t.playlist.tracks,"item-size":60,"key-field":"id"},scopedSlots:t._u([{key:"default",fn:function(e){var s=e.item;return[a("div",{staticClass:"song-view",attrs:{active:t.playlist.activeTrack.id===s.id},on:{click:function(e){return t.$emit("play",s)}}},[s.caching?a("md-icon",{staticClass:"icon"},[t._v("cached")]):a("md-icon",{staticClass:"icon",style:s.offline?"opacity: 0.5":"opacity: 0"},[t._v("cloud_done")]),a("div",{staticClass:"song-info"},[a("p",{staticClass:"title"},[t._v(t._s(s.title))]),a("p",{staticClass:"artists"},[t._v(t._s(s.artists)+" â€¢ "+t._s(s.durationHms))])])],1)]}}])})],1)},S=[],P={name:"PlaylistView",props:{playlist:k}},b=P,_=(a("a809"),Object(n["a"])(b,T,S,!1,null,"1dd93814",null)),C=_.exports,M=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("md-content",{staticClass:"media-player-view player-card md-primary"},[a("div",{staticClass:"track-card"},[a("div",{staticClass:"album-art",style:{"background-image":"url("+t.currentPlaylist.activeTrack.albumArt+")"}}),a("div",{staticClass:"track-info"},[a("span",[t._v(t._s(t.currentPlaylist.activeTrack.title))]),a("span",[t._v(t._s(t.currentPlaylist.activeTrack.artists))])])]),a("div",{staticClass:"seek-bar",on:{mousedown:t.seekDown,touchstart:function(e){return t.seekDown(e.touches[0])}}},[a("span",{staticClass:"track-time"},[t._v(t._s(t.utils.secondsToHms(t.trackProgress*t.currentPlaylist.activeTrack.duration)))]),a("div",{ref:"seekContainer",staticClass:"seek-container"},[a("div",{staticClass:"seek-progress",style:{width:Math.round(100*t.trackProgress)+"%"}}),a("div",{staticClass:"seek-thumb",style:{left:"calc("+Math.round(100*t.trackProgress)+"% - 16px / 2)"}})]),a("span",{staticClass:"track-duration"},[t._v(t._s(t.currentPlaylist.activeTrack.durationHms))])]),a("div",{staticClass:"music-controls"},[a("md-button",{staticClass:"md-icon-button",on:{click:function(e){t.shuffle=!t.shuffle}}},[a("md-icon",{style:t.shuffle?"opacity: 1":"opacity: 0.6"},[t._v("shuffle")])],1),a("md-button",{staticClass:"md-icon-button",on:{click:t.skipPrevious}},[a("md-icon",[t._v("skip_previous")])],1),t.playing?a("md-button",{staticClass:"md-icon-button md-raised",on:{click:function(e){return t.pause()}}},[a("md-icon",[t._v("pause")])],1):a("md-button",{staticClass:"md-icon-button md-raised",on:{click:function(e){return t.play()}}},[a("md-icon",[t._v("play_arrow")])],1),a("md-button",{staticClass:"md-icon-button",on:{click:t.skipNext}},[a("md-icon",[t._v("skip_next")])],1),a("md-button",{staticClass:"md-icon-button",on:{click:function(e){t.repeat=!t.repeat}}},[a("md-icon",{style:t.repeat?"opacity: 1":"opacity: 0.6"},[t._v("repeat")])],1)],1),a("audio",{ref:"player",staticClass:"audio-player"})])},O=[];class x{async cacheIfNotCached(t){await m.awaitReady(),await m.exists(t.id)?console.log("not caching song",t.title,"already available offline"):await this.cache(t)}async cache(t){return new Promise(async(e,a)=>{if(t.caching)return;t.caching=!0,console.log("Caching",t.title,"now");let s=p.getServer()+"/download/?query="+encodeURIComponent(t.query);console.log("Downloading url:",s);let i=await fetch(s),r=await i.blob(),n=await m.createFileFromBlob(t.id,r);n.getMetadata(a=>{console.log(`Song ${t.title} caching complete: `,n,"metadata",a),t.caching=!1,t.setOffline(),e(t)})})}}var $=new x,R={name:"media-player-view",data(){return{utils:p,timeUpdater:-1,shuffle:!1,repeat:!0,playing:!1,songProgress:0,seeking:!1,trackProgress:0,loadedLastPlayed:!1}},props:{currentPlaylist:k},mounted(){null!==localStorage.getItem("shuffle")&&(this.shuffle=JSON.parse(localStorage.shuffle)),null!==localStorage.getItem("repeat")&&(this.repeat=JSON.parse(localStorage.repeat)),document.addEventListener("mousemove",t=>this.mouseMove(t)),document.addEventListener("touchmove",t=>this.mouseMove(t.touches[0])),document.addEventListener("mouseup",t=>this.mouseUp(t)),document.addEventListener("touchend",t=>this.mouseUp(t.touches[0])),this.timeUpdater=setInterval(()=>{let t=this.$refs.player.currentTime/this.currentPlaylist.activeTrack.duration;t=Math.max(Math.min(t,1),0),this.trackProgress=t},100)},methods:{async playTrack(t,e=!1,a=!1){if(!a&&t.id===this.currentPlaylist.activeTrack.id)return this.$refs.player.currentTime=0,void(e||this.play());let s;localStorage.lastPlayed=t.id,this.currentPlaylist.activeTrack=t,this.setTrackMetaData(t),await m.awaitReady(),await m.exists(t.id)?s=(await m.getFileByName(t.id)).toURL():(s=p.getServer()+"/stream/?query="+encodeURIComponent(t.query),$.cacheIfNotCached(t)),console.log("Playing",t.title,"URL:",s);let i=this.$refs.player;i.src=s,i.oncanplay=async()=>{await this.play()},i.onended=()=>this.skipNext()},async play(){""!==this.currentPlaylist.activeTrack.title&&(this.playing=!0,await this.$refs.player.play())},pause(){""!==this.currentPlaylist.activeTrack.title&&(this.playing=!1,this.$refs.player.pause())},skipNext(){let t=this.currentPlaylist.tracks.indexOf(this.currentPlaylist.activeTrack);if(t===this.currentPlaylist.tracks.length-1){if(!this.repeat)return void console.log("Not skipping, repeat is off");t=-1}this.shuffle?this.playTrack(this.currentPlaylist.shuffledTracks[t+1]):this.playTrack(this.currentPlaylist.tracks[t+1])},skipPrevious(){let t=this.$refs.player;if(t.currentTime<5){let t=this.currentPlaylist.tracks.indexOf(this.currentPlaylist.activeTrack);0===t&&(t=this.currentPlaylist.tracks.length),this.shuffle?this.playTrack(this.currentPlaylist.shuffledTracks[t-1]):this.playTrack(this.currentPlaylist.tracks[t-1])}else t.currentTime=0},mouseUp(){this.seeking&&(this.seeking=!1)},mouseMove(t){this.seeking&&this.seekToEvent(t)},seekDown(t){this.seeking=!0,this.seekToEvent(t)},seekToEvent(t){let e=(t.pageX-this.$refs.seekContainer.offsetLeft)/this.$refs.seekContainer.offsetWidth;e=Math.max(Math.min(e,1),0),this.trackProgress=e;let a=this.currentPlaylist.activeTrack.duration;this.$refs.player.currentTime=a*e},setTrackMetaData(t){document.title=t.artists+" - "+t.title,"mediaSession"in navigator&&(navigator.mediaSession.metadata=new MediaMetadata({title:t.title,artist:t.artists,artwork:[{src:t.albumArt,type:"image/png"}]}),navigator.mediaSession.setActionHandler("play",async()=>{await this.play()}),navigator.mediaSession.setActionHandler("pause",async()=>{await this.pause()}),navigator.mediaSession.setActionHandler("previoustrack",()=>{this.skipNext()}),navigator.mediaSession.setActionHandler("nexttrack",()=>{this.skipPrevious()}))}},watch:{currentPlaylist(){let t=this.currentPlaylist.tracks.find(t=>t.id===localStorage.lastPlayed);console.log("Last played track",t),t&&(this.currentPlaylist.activeTrack=t,this.loadedLastPlayed||(this.playTrack(t,!0,!0),this.loadedLastPlayed=!0))},shuffle(){localStorage.shuffle=this.shuffle},repeat(){localStorage.repeat=this.repeat}},beforeDestroy(){clearInterval(this.timeUpdater)}},N=R,F=(a("3c4e"),Object(n["a"])(N,M,O,!1,null,"dd5701f0",null)),A=F.exports;console.log(m);var E={name:"home",components:{PlaylistView:C,MediaPlayerView:A},data(){return{loadingFs:!0,likedTracks:k.empty()}},async mounted(){m.awaitReady().then(()=>this.loadingFs=!1),null!==localStorage.getItem("likedTracks")&&(this.likedTracks=k.importJson(localStorage.likedTracks)),w.getLikedTracks().then(t=>{this.likedTracks=t,localStorage.likedTracks=this.likedTracks.exportJson()})},methods:{playMedia(t){this.$refs.mediaPlayer.playTrack(t)}}},J=E,L=(a("3611"),Object(n["a"])(J,d,h,!1,null,"158904c0",null)),j=L.exports;s["default"].use(u["a"]);var I=new u["a"]({routes:[{path:"/",name:"home",component:j}]}),q=a("9483");Object(q["a"])("/vuemusic/service-worker.js",{ready(){console.log("App is being served from cache by a service worker.\nFor more details, visit https://goo.gl/AFskqB")},registered(){console.log("Service worker has been registered.")},cached(){console.log("Content has been cached for offline use.")},updatefound(){console.log("New content is downloading.")},updated(){console.log("New content is available; please refresh.")},offline(){console.log("No internet connection found. App is running in offline mode.")},error(t){console.error("Error during service worker registration:",t)}});var U=a("e508"),D=(a("a899"),a("9c30"));a("51de"),a("9d4f");s["default"].config.productionTip=!1,s["default"].component("RecycleScroller",U["a"]),s["default"].use(D["MdButton"]),s["default"].use(D["MdContent"]),s["default"].use(D["MdList"]),s["default"].use(D["MdIcon"]),s["default"].use(D["MdSwitch"]),s["default"].use(D["MdProgress"]),new s["default"]({router:I,render:function(t){return t(c)}}).$mount("#app")},"64a9":function(t,e,a){},"9cfa":function(t,e,a){},"9d4f":function(t,e,a){},a809:function(t,e,a){"use strict";var s=a("f272"),i=a.n(s);i.a},f272:function(t,e,a){}});
//# sourceMappingURL=app.db99d9ea.js.map