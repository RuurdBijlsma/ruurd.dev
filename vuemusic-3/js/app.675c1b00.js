(function(t){function e(e){for(var a,n,o=e[0],l=e[1],c=e[2],d=0,h=[];d<o.length;d++)n=o[d],Object.prototype.hasOwnProperty.call(i,n)&&i[n]&&h.push(i[n][0]),i[n]=0;for(a in l)Object.prototype.hasOwnProperty.call(l,a)&&(t[a]=l[a]);u&&u(e);while(h.length)h.shift()();return r.push.apply(r,c||[]),s()}function s(){for(var t,e=0;e<r.length;e++){for(var s=r[e],a=!0,o=1;o<s.length;o++){var l=s[o];0!==i[l]&&(a=!1)}a&&(r.splice(e--,1),t=n(n.s=s[0]))}return t}var a={},i={app:0},r=[];function n(e){if(a[e])return a[e].exports;var s=a[e]={i:e,l:!1,exports:{}};return t[e].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=t,n.c=a,n.d=function(t,e,s){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},n.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)n.d(s,a,function(e){return t[e]}.bind(null,a));return s},n.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="/vuemusic/";var o=window["webpackJsonp"]=window["webpackJsonp"]||[],l=o.push.bind(o);o.push=e,o=o.slice();for(var c=0;c<o.length;c++)e(o[c]);var u=l;r.push([0,"chunk-vendors"]),s()})({0:function(t,e,s){t.exports=s("56d7")},"034f":function(t,e,s){"use strict";var a=s("64a9"),i=s.n(a);i.a},"23c4":function(t,e,s){},"3c4e":function(t,e,s){"use strict";var a=s("9cfa"),i=s.n(a);i.a},"4bd9":function(t,e,s){"use strict";var a=s("b576"),i=s.n(a);i.a},"56d7":function(t,e,s){"use strict";s.r(e);var a=s("2b0e"),i=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{attrs:{id:"app"}},[s("router-view")],1)},r=[],n=(s("034f"),s("2877")),o={},l=Object(n["a"])(o,i,r,!1,null,null,null),c=l.exports,u=s("8c4f"),d=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"home"},[t.loadingFs?s("md-progress-bar",{attrs:{"md-mode":"indeterminate"}}):t._e(),s("md-content",[s("playlist-view",{staticClass:"playlist-view",attrs:{playlist:t.likedTracks},on:{play:t.playMedia}})],1),s("media-player-view",{ref:"mediaPlayer",staticClass:"media-player",attrs:{"current-playlist":t.likedTracks}})],1)},h=[];class f{constructor(t,e,s){this.accessToken=t,this.expires=e,this.type=s}static fromJson(t){if(!t)return!1;try{let e=JSON.parse(t);return new f(e.accessToken,e.expires,e.type)}catch(e){return console.warn("Token parse error",e),!1}}}class p{static getServer(){return this.isLocal()?"http://localhost:3000":"https://ruurd.dev:3000"}static isLocal(){return location.href.includes("localhost")||location.href.includes("127.0.0.1")||location.href.includes("192.168.0")}static secondsToHms(t){if(isNaN(t)||void 0===t)return"0:00";t=Math.round(t);let e=Math.floor(t/3600),s=Math.floor(t%3600/60),a=t%60;return e=e.toString(),s=s.toString(),a=a.toString(),"0"!==e&&(s=s.padStart(2,"0"),a=a.padStart(2,"0")),a=a.padStart(2,"0"),"0"===e?`${s}:${a}`:`${e}:${s}:${a}`}static shuffleArray(t){for(let e=t.length-1;e>0;e--){const s=Math.floor(Math.random()*(e+1));[t[e],t[s]]=[t[s],t[e]]}return t}}class y{constructor(){this.isReady=!1,this.requestSize=536870912,this.events={},this.getFileSystem().then(async t=>{this.fileSystem=t,await this.requestMoreQuota(this.requestSize),this.isReady=!0,console.log("File storage loaded!"),this.fire("ready")})}async awaitReady(){return new Promise(t=>{this.isReady&&t(),this.on("ready",()=>{t()})})}get root(){return this.fileSystem.root}async exists(t,e=this.root){let s=await this.getFileByName(t,e);return void 0!==s}async getFileByName(t,e=this.root){let s=await this.getDirectoryFiles(e);return s.find(e=>e.name===t)}async getDirectoryFiles(t=this.root){return new Promise((e,s)=>{let a=t.createReader();a.readEntries(t=>e(t),t=>s(t))})}async getFileSystem(){return new Promise((t,e)=>{window.webkitRequestFileSystem(window.PERSISTENT,0,e=>t(e),t=>e(t))})}async requestMoreQuota(t){return new Promise((e,s)=>{navigator.webkitPersistentStorage.requestQuota(t,t=>e(t),t=>s(t))})}async getCurrentQuota(){return new Promise((t,e)=>{navigator.webkitTemporaryStorage.queryUsageAndQuota((e,s)=>t({usedBytes:e,grantedBytes:s}),t=>e(t))})}async createFileFromBlob(t,e,s=this.root){let a=await this.createFile(t,s);return await this.writeToFile(e,a),a}async createFile(t,e=this.root){return console.log("file 1"),new Promise((s,a)=>{e.getFile(t,{create:!0,exclusive:!1},t=>s(t),t=>a(t))})}async writeToFile(t,e){return new Promise((s,a)=>{e.createWriter(e=>{e.onwriteend=t=>s(t),e.onerror=t=>a(t),e.write(t)})})}on(t,e){this.events[t]||(this.events[t]=[]),this.events[t].push(e)}off(t,e){this.events[t]&&this.events[t].splice(this.events.indexOf(e),1)}fire(t){if(this.events[t])for(let e of this.events[t])e()}}var m=new y;class g{constructor(t,e,s,a,i,r){this.id=t,this.title=e,this.artists=s,this.albumArt=a,this.duration=i/1e3,this.durationHms=p.secondsToHms(this.duration),this.addedAt=r,this.offline=!1,this.caching=!1,this.getCachedOfflineStatus()}static empty(){return new g("0","","","",0,0)}static fromJson(t){if(t)try{let e=JSON.parse(t);return new g(e.id,e.title,e.artists,e.albumArt,1e3*e.duration,e.addedAt)}catch(e){console.error("Can't parse ",e,"JSON:",t)}}static fromRawTrack(t){let e=t.track;return new g(e.id,e.name,e.artists.map(t=>t.name).join(", "),e.album.images[0].url,e.duration_ms,new Date(t.added_at))}get query(){return`${this.title} - ${this.artists}`}setOffline(){this.offline=!0;let t="offlineTrack"+this.id;localStorage[t]=this.offline}getCachedOfflineStatus(){let t="offlineTrack"+this.id;null!==localStorage.getItem(t)&&(this.offline="true"===localStorage[t])}async getOfflineStatus(){let t="offlineTrack"+this.id;await m.awaitReady(),this.offline=await m.exists(this.id),localStorage[t]=this.offline}}class k{constructor(t,e){this.name=t,this.tracks=e,this.activeTrack=e.length>0?e[0]:g.empty(),this.shuffledTracks=[],this.reshuffle()}exportJson(){return JSON.stringify({name:this.name,tracks:this.tracks})}static importJson(t){if(!t)return!1;try{let e=JSON.parse(t),s=e.tracks.map(t=>new g(t.id,t.title,t.artists,t.albumArt,1e3*t.duration,t.addedAt));return m.awaitReady().then(()=>{s.forEach(t=>t.getOfflineStatus())}),new k(e.name,s)}catch(e){console.error("Cant parse playlist",e,"JSON",t)}}static fromRawTracks(t,e){let s=e.map(g.fromRawTrack);return m.awaitReady().then(()=>{s.forEach(t=>t.getOfflineStatus())}),new k(t,s)}reshuffle(){this.shuffledTracks=p.shuffleArray([...this.tracks])}static empty(){return new k("",[])}}class v{constructor(){this.token=!1}async getLikedTracks(){let t="https://api.spotify.com/v1/me/tracks?limit=50",e=await this.requestPaginatedResource(t);return k.fromRawTracks("Liked songs",e)}async requestPaginatedResource(t){let e=await this.getToken(),s=[];while(t){let a=await(await fetch(t,{method:"GET",headers:{Authorization:"Bearer "+e.accessToken}})).json();t=a.next,s=s.concat(a.items)}return s}static verifyToken(t){if(!t)return!1;let e=Math.floor(+new Date/1e3),s=t.expires-e;return s>60}async getToken(){if(v.verifyToken(this.token))return this.token;if(null!==localStorage.getItem("token")){let t=f.fromJson(localStorage.token);if(v.verifyToken(t))return console.log("using localStorage token"),t}console.log("requesting new token");let t=await this.getTokenFromApi();return localStorage.token=JSON.stringify(t),this.token=t,t}async getTokenFromApi(){return new Promise((t,e)=>{const s="cd272aa2194c46c7a460e9a202f66002";let a=p.isLocal()?"http://localhost:8080/vuemusic/#/":"https://ruurd.dev/vuemusic/#/",i="user-library-read",r=Math.round(1e7*Math.random()).toString(),n=`https://accounts.spotify.com/authorize?response_type=token&state=${r}&client_id=${s}${i?"&scope="+encodeURIComponent(i):""}&redirect_uri=${encodeURIComponent(a)}`,o=window.open(n);console.log(o);let l=setInterval(()=>{let s=o.location.hash;if(s&&(o.close(),clearInterval(l),s.includes("error")&&(console.log("ERROR:",s),e(s)),s.includes("access_token"))){console.log("TOKEN:",s);let a=s.split("access_token=")[1].split("&")[0],i=s.split("token_type=")[1].split("&")[0],n=s.split("expires_in=")[1].split("&")[0],o=s.split("state=")[1].split("&")[0],l=Math.floor(+new Date/1e3)+ +n,c=new f(a,l,i);if(o!==r)return void e({message:`State doens't match: ${o}, ${r}`,token:c});t(c)}console.log(o.location.hash)},100)})}}var w=new v,T=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"playlist-view"},[s("h2",{staticClass:"playlist-name"},[t._v("\n        "+t._s(t.playlist.name)+"\n    ")]),s("div",{staticClass:"cache-button-container"},[s("md-button",{on:{click:t.cacheAll}},[t._v("Cache all songs")]),s("p",[t._v(t._s(t.progressString))])],1),s("recycle-scroller",{staticClass:"song-list",attrs:{items:t.playlist.tracks,"item-size":60,"key-field":"id"},scopedSlots:t._u([{key:"default",fn:function(e){var a=e.item;return[s("div",{staticClass:"song-view",attrs:{active:t.playlist.activeTrack.id===a.id},on:{click:function(e){return t.$emit("play",a)}}},[a.caching?s("md-icon",{staticClass:"icon"},[t._v("cached")]):s("md-icon",{staticClass:"icon",style:a.offline?"opacity: 0.5":"opacity: 0"},[t._v("cloud_done")]),s("div",{staticClass:"song-info"},[s("p",{staticClass:"title"},[t._v(t._s(a.title))]),s("p",{staticClass:"artists"},[t._v(t._s(a.artists)+" â€¢ "+t._s(a.durationHms))])])],1)]}}])})],1)},S=[];class b{cacheMultiple(t,e){let s=5;e(this.countCachedSongs(t));let a=setInterval(()=>{let s=this.countCachedSongs(t);e(s),s>=t.length&&clearInterval(a)},2e3);for(let i=0;i<s;i++)this.synchronousRecursiveCache(t)}countCachedSongs(t){let e=t.map(t=>t.offline).reduce((t,e)=>t+e);return e}synchronousRecursiveCache(t){for(let e of t)if(!e.offline&&!e.caching&&!e.syncCache){e.syncCache=!0,this.cacheIfNotCached(e).then(()=>this.synchronousRecursiveCache(t));break}}async cacheIfNotCached(t){await m.awaitReady(),await m.exists(t.id)?console.log("not caching song",t.title,"already available offline"):await this.cache(t)}async cache(t){return new Promise(async(e,s)=>{if(t.caching)return;t.caching=!0,console.log("Caching",t.title,"now");let a=p.getServer()+"/download/?query="+encodeURIComponent(t.query);console.log("Downloading url:",a);let i=await fetch(a),r=await i.blob(),n=await m.createFileFromBlob(t.id,r);n.getMetadata(s=>{console.log(`Song ${t.title} caching complete: `,n,"metadata",s),t.caching=!1,t.setOffline(),e(t)})})}}var P=new b,C={name:"PlaylistView",data(){return{progressString:""}},mounted(){let t=document.querySelector(".song-list");t.style.height=window.innerHeight-250-37-t.offsetTop+"px"},props:{playlist:k},methods:{cacheAll(){P.cacheMultiple(this.playlist.tracks,t=>{this.progressString=`Downloaded ${t} / ${this.playlist.tracks.length} songs`})}}},_=C,M=(s("4bd9"),Object(n["a"])(_,T,S,!1,null,"76c973ef",null)),O=M.exports,x=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("md-content",{staticClass:"media-player-view player-card md-primary"},[s("div",{staticClass:"track-card"},[s("div",{staticClass:"album-art",style:{"background-image":"url("+t.currentPlaylist.activeTrack.albumArt+")"}}),s("div",{staticClass:"track-info"},[s("span",[t._v(t._s(t.currentPlaylist.activeTrack.title))]),s("span",[t._v(t._s(t.currentPlaylist.activeTrack.artists))])])]),s("div",{staticClass:"seek-bar",on:{mousedown:t.seekDown,touchstart:function(e){return t.seekDown(e.touches[0])}}},[s("span",{staticClass:"track-time"},[t._v(t._s(t.utils.secondsToHms(t.trackProgress*t.currentPlaylist.activeTrack.duration)))]),s("div",{ref:"seekContainer",staticClass:"seek-container"},[s("div",{staticClass:"seek-progress",style:{width:Math.round(100*t.trackProgress)+"%"}}),s("div",{staticClass:"seek-thumb",style:{left:"calc("+Math.round(100*t.trackProgress)+"% - 16px / 2)"}})]),s("span",{staticClass:"track-duration"},[t._v(t._s(t.currentPlaylist.activeTrack.durationHms))])]),s("div",{staticClass:"music-controls"},[s("md-button",{staticClass:"md-icon-button",on:{click:function(e){t.shuffle=!t.shuffle}}},[s("md-icon",{style:t.shuffle?"opacity: 1":"opacity: 0.6"},[t._v("shuffle")])],1),s("md-button",{staticClass:"md-icon-button",on:{click:t.skipPrevious}},[s("md-icon",[t._v("skip_previous")])],1),t.playing?s("md-button",{staticClass:"md-icon-button md-raised",on:{click:function(e){return t.pause()}}},[s("md-icon",[t._v("pause")])],1):s("md-button",{staticClass:"md-icon-button md-raised",on:{click:function(e){return t.play()}}},[s("md-icon",[t._v("play_arrow")])],1),s("md-button",{staticClass:"md-icon-button",on:{click:t.skipNext}},[s("md-icon",[t._v("skip_next")])],1),s("md-button",{staticClass:"md-icon-button",on:{click:function(e){t.repeat=!t.repeat}}},[s("md-icon",{style:t.repeat?"opacity: 1":"opacity: 0.6"},[t._v("repeat")])],1)],1),s("audio",{ref:"player",staticClass:"audio-player"})])},R=[],$={name:"media-player-view",data(){return{utils:p,timeUpdater:-1,shuffle:!1,repeat:!0,playing:!1,songProgress:0,seeking:!1,trackProgress:0,loadedLastPlayed:!1}},props:{currentPlaylist:k},mounted(){null!==localStorage.getItem("shuffle")&&(this.shuffle=JSON.parse(localStorage.shuffle)),null!==localStorage.getItem("repeat")&&(this.repeat=JSON.parse(localStorage.repeat)),document.addEventListener("mousemove",t=>this.mouseMove(t)),document.addEventListener("touchmove",t=>this.mouseMove(t.touches[0])),document.addEventListener("mouseup",t=>this.mouseUp(t)),document.addEventListener("touchend",t=>this.mouseUp(t.touches[0])),this.timeUpdater=setInterval(()=>{let t=this.$refs.player.currentTime/this.currentPlaylist.activeTrack.duration;t=Math.max(Math.min(t,1),0),this.trackProgress=t},100)},methods:{async playTrack(t,e=!1,s=!1){if(!s&&t.id===this.currentPlaylist.activeTrack.id)return this.$refs.player.currentTime=0,void(e||this.play());let a;localStorage.lastPlayed=t.id,this.currentPlaylist.activeTrack=t,this.setTrackMetaData(t),await m.awaitReady(),await m.exists(t.id)?a=(await m.getFileByName(t.id)).toURL():(a=p.getServer()+"/stream/?query="+encodeURIComponent(t.query),P.cacheIfNotCached(t)),console.log("Playing",t.title,"URL:",a);let i=this.$refs.player;i.src=a,i.oncanplay=async()=>{await this.play()},i.onended=()=>this.skipNext()},async play(){""!==this.currentPlaylist.activeTrack.title&&(this.playing=!0,await this.$refs.player.play())},pause(){""!==this.currentPlaylist.activeTrack.title&&(this.playing=!1,this.$refs.player.pause())},skipNext(){let t=this.currentPlaylist.tracks.indexOf(this.currentPlaylist.activeTrack);if(t===this.currentPlaylist.tracks.length-1){if(!this.repeat)return void console.log("Not skipping, repeat is off");t=-1}this.shuffle?this.playTrack(this.currentPlaylist.shuffledTracks[t+1]):this.playTrack(this.currentPlaylist.tracks[t+1])},skipPrevious(){let t=this.$refs.player;if(t.currentTime<5){let t=this.currentPlaylist.tracks.indexOf(this.currentPlaylist.activeTrack);0===t&&(t=this.currentPlaylist.tracks.length),this.shuffle?this.playTrack(this.currentPlaylist.shuffledTracks[t-1]):this.playTrack(this.currentPlaylist.tracks[t-1])}else t.currentTime=0},mouseUp(){this.seeking&&(this.seeking=!1)},mouseMove(t){this.seeking&&this.seekToEvent(t)},seekDown(t){this.seeking=!0,this.seekToEvent(t)},seekToEvent(t){let e=(t.pageX-this.$refs.seekContainer.offsetLeft)/this.$refs.seekContainer.offsetWidth;e=Math.max(Math.min(e,1),0),this.trackProgress=e;let s=this.currentPlaylist.activeTrack.duration;this.$refs.player.currentTime=s*e},setTrackMetaData(t){document.title=t.artists+" - "+t.title,"mediaSession"in navigator&&(navigator.mediaSession.metadata=new MediaMetadata({title:t.title,artist:t.artists,artwork:[{src:t.albumArt,type:"image/png"}]}),navigator.mediaSession.setActionHandler("play",async()=>{await this.play()}),navigator.mediaSession.setActionHandler("pause",async()=>{await this.pause()}),navigator.mediaSession.setActionHandler("previoustrack",()=>{this.skipNext()}),navigator.mediaSession.setActionHandler("nexttrack",()=>{this.skipPrevious()}))}},watch:{currentPlaylist(){let t=this.currentPlaylist.tracks.find(t=>t.id===localStorage.lastPlayed);console.log("Last played track",t),t&&(this.currentPlaylist.activeTrack=t,this.loadedLastPlayed||(this.playTrack(t,!0,!0),this.loadedLastPlayed=!0))},shuffle(){localStorage.shuffle=this.shuffle},repeat(){localStorage.repeat=this.repeat}},beforeDestroy(){clearInterval(this.timeUpdater)}},N=$,F=(s("3c4e"),Object(n["a"])(N,x,R,!1,null,"dd5701f0",null)),A=F.exports,E={name:"home",components:{PlaylistView:O,MediaPlayerView:A},data(){return{loadingFs:!0,likedTracks:k.empty()}},async mounted(){m.awaitReady().then(()=>this.loadingFs=!1),null!==localStorage.getItem("likedTracks")&&(this.likedTracks=k.importJson(localStorage.likedTracks)),w.getLikedTracks().then(t=>{this.likedTracks=t,console.log(P,t),localStorage.likedTracks=this.likedTracks.exportJson()})},methods:{playMedia(t){this.$refs.mediaPlayer.playTrack(t)}}},I=E,J=(s("7abb"),Object(n["a"])(I,d,h,!1,null,"0be7a335",null)),L=J.exports;a["default"].use(u["a"]);var j=new u["a"]({routes:[{path:"/",name:"home",component:L}]}),q=s("9483");Object(q["a"])("/vuemusic/service-worker.js",{ready(){console.log("App is being served from cache by a service worker.\nFor more details, visit https://goo.gl/AFskqB")},registered(){console.log("Service worker has been registered.")},cached(){console.log("Content has been cached for offline use.")},updatefound(){console.log("New content is downloading.")},updated(){console.log("New content is available; please refresh.")},offline(){console.log("No internet connection found. App is running in offline mode.")},error(t){console.error("Error during service worker registration:",t)}});var D=s("e508"),U=(s("a899"),s("9c30"));s("51de"),s("9d4f");a["default"].config.productionTip=!1,a["default"].component("RecycleScroller",D["a"]),a["default"].use(U["MdButton"]),a["default"].use(U["MdContent"]),a["default"].use(U["MdList"]),a["default"].use(U["MdIcon"]),a["default"].use(U["MdSwitch"]),a["default"].use(U["MdProgress"]),new a["default"]({router:j,render:function(t){return t(c)}}).$mount("#app")},"64a9":function(t,e,s){},"7abb":function(t,e,s){"use strict";var a=s("23c4"),i=s.n(a);i.a},"9cfa":function(t,e,s){},"9d4f":function(t,e,s){},b576:function(t,e,s){}});
//# sourceMappingURL=app.675c1b00.js.map